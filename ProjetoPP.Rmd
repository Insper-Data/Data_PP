---
title: "Projeto Insper Data - Politicas Publicas"
author: "Bruno, Bernardo e Vinicius"
date: "14/09/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


Pacotes
```{r}

library(estimatr)
library(janitor)
library(vctrs)
library(tidyverse)
library(skimr)
library(readxl)
library(stringi)
library(rvest)
library(lubridate)
library(ggthemes)
library(spData)
library(ggrepel)
library(sf)
library(gganimate)
library(av)
library(broom)

```



Puxando as bases
```{r}

covid <- read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")


tests <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/testing/covid-testing-all-observations.csv")


CRT <- read_csv("https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv")


wjp_2019 <- read_excel("FINAL_2020_wjp_rule_of_law_index_HISTORICAL.xlsx", 
                        sheet = "WJP ROL Index 2019 Scores") 


democracy <- read_excel("EIU-Democracy Indices - Dataset - v3.xlsx", 
    sheet = "input-data-from-EIU-recentyrs", skip = 176)


giniOWID <- read_csv("economic-inequality-gini-index.csv")

iso_codes <- read_csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv") %>% 
   transmute(code = as.numeric(`country-code`),
             name,
             iso_code = `alpha-3`,
             region,
             iso2 = `alpha-2`) %>% 
  clean_names()

```




Limpando as bases
```{r}

# Limpando a base de testes (Our World in Data)

t <- tests %>% 
  select("Entity":"ISO code", "Daily change in cumulative total":"Short-term positive rate") %>% 
  separate(Entity, c("country", "escala"), sep = " - ") %>% 
  rename(date = Date) %>% 
  rename("iso_code" = "ISO code")
 
# Limpando a base Democracy Index (democracy)

skim(democracy)

colnames(democracy)[1] <- "location"


democracy %>% 
        filter(!is.na(location)) %>% 
        mutate(`Electoral process and pluralism` = as.double(`Electoral process and pluralism`)) %>% 
        mutate(Rank = str_remove(Rank, "[=]$")) %>%
        anti_join(iso, by = c("location" = "name")) %>% view
        

rm(iso)

iso <- iso_codes %>% 
        mutate_if(is.character, str_replace_all,
                  pattern = "United Kingdom of Great Britain and Northern Ireland", replacement = "United Kingdom") %>%
        mutate_if(is.character, str_replace_all, pattern = "Korea, Republic of", replacement = "South Korea") %>%
        mutate_if(is.character, str_replace_all, pattern = "Taiwan, Province of China", replacement = "Taiwan") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Czechia", replacement = "Czech Republic") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Moldova.*", replacement = "Moldova") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Tanzania, United Republic of", replacement = "Tanzania") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Kyrgyzstan", replacement = "Kyrgyz Republic") %>%
        mutate_if(is.character, str_replace_all, pattern = "Bolivia.*", replacement = "Bolivia") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Palestine, State of", replacement = "Palestine") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Congo(?!,)", replacement = "Congo (Brazzaville)") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Russian Federation", replacement = "Russia") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Venezuela \\(Bolivarian Republic of\\)", replacement = "Venezuela") %>%
        mutate_if(is.character, str_replace_all, pattern = "Iran \\(Islamic Republic of\\)", replacement = "Iran") %>%
        mutate_if(is.character, str_replace_all, pattern = "Lao People's Democratic Republic", replacement = "Laos") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Syrian Arab Republic", replacement = "Syria") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Congo, Democratic Republic of the", replacement = "Democratic Republic of Congo") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Korea \\(Democratic People's Republic of\\)", replacement = "North Korea") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Bosnia and Herzegovina", replacement = "Bosnia and Hercegovina") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Côte d'Ivoire", replacement = "Côte d’Ivoire") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Viet Nam", replacement = "Vietnam") %>% 
        mutate_if(is.character, str_replace_all, pattern = "Eswatini", replacement = "eSwatini")


dmi <- democracy %>% 
        filter(!is.na(location)) %>% 
        mutate(`Electoral process and pluralism` = as.double(`Electoral process and pluralism`)) %>% 
        mutate(Rank = str_remove(Rank, "[=]$")) %>%
        left_join(iso, by = c("location" = "name")) %>% 
        mutate(location = str_remove(location, "of America")) %>% 
        mutate(Rank = as.integer(Rank)) %>% 
        mutate(type = case_when(
                      Rank <= 22 ~ "Full democracy",
                      Rank >= 23 & Rank <= 75 ~ "Flawed democracy",
                      Rank >= 77 & Rank <= 113 ~ "Hybrid regime",
                      Rank >= 114 ~ "Authoritarian regime"))

# Limpando a base World Justice Project (Instituições)

wjptidy <- wjp_2019 %>% 
  pivot_longer(-Country, names_to = "Countries", values_to = "Countries Codes") %>%
  pivot_wider(id_cols = c("Countries", "Countries Codes"), 
              names_from = "Country", values_from = "Countries Codes") %>% 
  select(-6) %>% 
  rename("iso_code" = "Country Code") %>% 
  rename("country_name" = "Countries")

wjptidy[, c(5:57)] <- sapply(wjptidy[, c(5:57)], as.numeric)

# Limpando Response Tracker


contador = round(as.numeric(difftime(Sys.Date(), "2020-09-13", units = "days"))) # gera um contador para restaura os EUA e UK
dias = (1: (257 + contador))

cpt <- CRT %>% 
  clean_names() %>% 
  mutate(date = ymd(date)) %>% 
  rename(c("iso_code" = "country_code")) %>% 
  select(- c(region_name, region_code)) %>% 
  relocate(confirmed_cases, .after = country_name)
  

us <- cpt %>% 
  filter(country_name == "United States") %>% 
  slice(dias)

uk <- cpt %>% 
  filter(country_name == "United Kingdom") %>% 
  slice(dias)


cpt <- cpt %>% 
  filter(country_name != "United States" & iso_code != "USA") %>% 
  filter(country_name != "United Kingdom" & iso_code != "GBR") %>%
  bind_rows(us) %>% 
  bind_rows(uk)

#Limpando Gini

giniOWIDlatest <- giniOWID %>% 
  group_by(Entity) %>% 
  filter(Year == max(Year)) %>% 
  rename(YearGINdata = Year) %>%
  clean_names() %>% 
  rename("iso_code" = "code")



```


Criando dicionario
```{r}

x <- cpt %>% 
  select(country_name, iso_code) %>% 
  unique()
  
###

y <- wjptidy %>% 
  select(country_name, iso_code)

x %>% anti_join(y, by = "iso_code") %>% view()

###

z <- covid %>% 
  select(location, iso_code) %>% 
  unique() %>% 
  clean_names()

z %>% anti_join(y, by = "iso_code") %>% view()


###

w <- t %>% 
  select(country, `ISO code`) %>% 
  unique()

###

y %>% anti_join(w, by = "iso_code") %>% view()

v <- giniOWIDlatest %>% 
  select(entity, code) %>% 
  rename("iso_code" = "code")

v %>% anti_join(w, by = "iso_code") %>% view()


###

u <- dmi %>% 
  select(location, iso_code)

u %>% anti_join(w, by = "iso_code") %>% view()


#### Criando o dicionario ####

rm(dici)

dici <- iso_codes %>% 
        left_join(z, by = "iso_code") %>% 
        left_join(x, by = "iso_code") %>%
        left_join(u, by = "iso_code") %>%
        left_join(v, by = "iso_code") %>%
        left_join(y, by = "iso_code") %>%
        left_join(w, by = "iso_code") %>% 
        rename("names_covid" = "location.x") %>% 
        rename("names_cpt" = "country_name.x") %>% 
        rename("names_dmi" = "location.y") %>% 
        rename("names_gini" = "entity") %>% 
        rename("names_wjp" = "country_name.y") %>% 
        rename("names_tests" = "country")


###

covid <- dici %>% 
  select(name:names_covid) %>% 
  right_join(covid, by = "iso_code") %>% 
  select(-continent, -location)


wjptidy <- dici %>% 
  select(name:iso2, names_wjp) %>% 
  right_join(wjptidy, by = "iso_code") %>% 
  select(-country_name)


cpt <- dici %>% 
  select(name:iso2, names_cpt) %>% 
  right_join(cpt, by = "iso_code") %>% 
  select(-country_name)


t <- dici %>% 
  select(name:iso2, names_tests) %>% 
  right_join(t, by = "iso_code") %>% 
  select(-country)


giniOWIDlatest <- dici %>% 
  select(name:iso2, names_gini) %>% 
  right_join(giniOWIDlatest, by = "iso_code") %>% 
  select(-entity)

```


Juntando as bases
```{r}
# Unificação do World Justice com CPT

wjp_cpt <- left_join(cpt, wjptidy, by = ("iso_code")) %>% 
            select(-country_name.y) %>% 
            rename(country_name = country_name.x)

# Juntando Our world in data (covid) + Our world in data (t) +  Democracy Index (dmi)

junto <- covid %>% 
  left_join(select(dmi, -location), by = "iso_code") %>% 
  left_join(t, by = c("location" = "country", "date" = "date")) %>% 
  select(-(new_tests:tests_units), -("ISO code")) %>% 
  filter(!is.na(type))


# Juntando tudo

base_semi <- left_join(wjp_cpt, junto,  by = c("country_name" = "location" , "date" = "date", "iso_code" =  "iso_code")) %>% 
  select(-Year)


#Juntando com Gini

base_inter <- left_join(base_semi, giniOWIDlatest, by = c("country_name" = "entity", "iso_code" = "code")) %>% 
  select(!(m1_wildcard))
```




Criando variável que conta quantos dias passaram desde que o país atingiu 1 caso por milhão de habitantes
```{r}
#Mesmo threshold do Our World In Data

marcador <- base_inter %>%
  filter(total_cases_per_million >= 1) %>% 
  group_by(country_name) %>% 
  mutate(rank = min_rank(total_cases_per_million)) %>% 
  mutate(days_after_1pm = rank(rank, ties.method = "first")) %>% 
  relocate(days_after_1pm, .after = date) %>% 
  ungroup()

#Alternativa
#group_by(country_name) %>%
#arrange(date) %>%
#mutate(rank = row_number()) %>% 
#ungroup()

#fazer uma análise da distribuição dos dias (o último valor para cada país), para ver como está a situação atual

base <- left_join(base_inter, marcador) %>% 
  relocate(c(days_after_1pm, total_cases_per_million), .after = date)

rm(uk, us, base_semi, base_inter, marcador)

```


Análise descritiva - Democracy Index

```{r}
skim(dmi)

dmi %>%
  ggplot(aes(x = reorder(location, -`Overall Score`), `Overall Score`, fill = type)) + 
  geom_col() +
  coord_flip() +
  theme_clean()

dmi %>%
  filter(`Overall Score` > 6) %>% 
  ggplot(aes(x = reorder(location, -`Overall Score`), `Overall Score`, fill = type)) + 
  geom_col() +
  coord_flip() +
  theme_clean()

dmi %>%
  filter(`Overall Score` < 6) %>% 
  ggplot(aes(x = reorder(location, -`Overall Score`), `Overall Score`, fill = type)) + 
  geom_col() +
  coord_flip() +
  theme_clean()


# Barplot em circulo

empty_bar <- 4
to_add <- data.frame(matrix(NA, empty_bar*nlevels(dmi$type), ncol(dmi)) )
colnames(to_add) <- colnames(dmi)
to_add$group <- rep(levels(dmi$type), each=empty_bar)
dmi <- rbind(dmi, to_add)
dmi <- dmi %>% arrange(group)
dmi$id <- seq(1, nrow(dmi))
 

label_data <- dmi
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     
label_data$hjust <- ifelse(angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle + 180, angle)
 

p <- ggplot(dmi, aes(x=as.factor(id), y=`Overall Score`, fill=type)) +       
  geom_bar(stat = "identity", alpha=0.5) +
  ylim(-50, 11) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-2,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data = label_data, aes(x = id, y = `Overall Score` + 1, label=location, hjust=hjust), color = "black", fontface = "bold",alpha=0.6,
            size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +
  labs(title = "Democracy Index")
 
p




# Mapa Overall Score

base %>% 
  select(country_name, iso_code, `Overall Score`, date) %>% 
  filter(!is.na(`Overall Score`), date == Sys.Date() - 1) %>%
  clean_names() %>%  
  left_join(iso) %>% 
  left_join(world, by = c("iso2" = "iso_a2")) %>% 
  ggplot() +
   geom_sf(aes(geometry = geom), data = world, fill = "lightgrey") +
   geom_sf(aes(geometry = geom, fill = overall_score)) +
   scale_fill_gradient(low = "#ff726f", high = "#0087C0", limits = c(1, 10), breaks = seq(1, 10, 1)) +
   labs(title = "Overall Score in the Democracy Index",
        subtitle = ("Values for 2019"),
        fill = "Index",
        caption = "Source: Democracy Index, The Economist") +
   theme_map() +
    theme(panel.background = element_rect(fill = "#b3d5e0"),
            legend.position = "right")


# Mapa tipos democracia

base %>% 
  select(country_name, iso_code, type, date, `Overall Score`) %>% 
  filter(!is.na(type), date == Sys.Date() - 1) %>%
  clean_names() %>%  
  left_join(iso) %>% 
  left_join(world, by = c("iso2" = "iso_a2")) %>% 
  ggplot() +
   geom_sf(aes(geometry = geom), data = world, fill = "lightgrey") +
   geom_sf(aes(geometry = geom, fill = type.x)) +
   labs(title = "Types of Democracy",
        subtitle = ("Democracy Index 2019"),
        fill = "",
        caption = "Source: Democracy Index, The Economist") +
   theme_map() +
    theme(panel.background = element_rect(fill = "#b3d5e0"),
          legend.position = "right")


```


Análise descritiva - Oxford Covid-19 Government Response Tracker

```{r}
skim(cpt)

#Análise das variáveis "flag", que indicam se as políticas foram específicas ou gerais.

cpt %>% 
  select(country_name, c1_flag, 
         c2_flag, c3_flag, c4_flag, c5_flag,
         c6_flag, c7_flag, e1_flag, h1_flag, iso_code) %>% 
  filter(!is.na(c1_flag), 
         !is.na(c2_flag), !is.na(c3_flag), 
         !is.na(c4_flag), !is.na(c5_flag),
         !is.na(c6_flag), !is.na(c7_flag), 
         !is.na(e1_flag), !is.na(h1_flag)) %>% 
  group_by(country_name, iso_code) %>%
  summarise(generalismo = mean((c1_flag + 
         c2_flag + c3_flag + c4_flag + c5_flag +
         c6_flag + c7_flag + e1_flag + h1_flag)/8)) %>% 
  left_join(iso) %>% 
  left_join(world, by = c("iso2" = "iso_a2")) %>%  
  ggplot() +
   geom_sf(aes(geometry = geom), data = world, fill = "lightgrey") +
   geom_sf(aes(geometry = geom, fill = generalismo)) +
  scale_fill_gradient(low = "darkslateblue", high = "seagreen3") +
   labs(title = "Level of Political Generalism",
        subtitle = ("Related to Pandemic Policies"),
        fill = "Index",
        caption = "Source: Oxford Policy Tracker") +
   theme_map() +
    theme(panel.background = element_rect(fill = "#b3d5d0"),
          legend.position = "right")


#Análise da variável C8 (International Travel Controls)

base %>% 
  select(country_name, c8_international_travel_controls, date, iso_code) %>% 
  filter(!is.na(c8_international_travel_controls), date == Sys.Date() - 30) %>%
  clean_names() %>%
  left_join(iso) %>% 
  left_join(world, by = c("iso2" = "iso_a2")) %>% 
  ggplot() +
   geom_sf(aes(geometry = geom), data = world, fill = "lightgrey") +
   geom_sf(aes(geometry = geom, fill = c8_international_travel_controls)) +
  scale_fill_gradient(low = "seagreen1", high = "deeppink3", limits = c(1, 4), breaks = seq(1, 4, 1)) +
   labs(title = "International Travel Controls",
        subtitle = ("In the beggining of September"),
        fill = "Index",
        caption = "Source: Oxford Policy Tracker") +
   theme_map() +
    theme(panel.background = element_rect(fill = "#b3d5e0"),
          legend.position = "right")

#Análise da relação entre C5 e E1

cpt %>% 
  select(country_name, c5_close_public_transport, e1_income_support) %>% 
  filter(!is.na(c5_close_public_transport), !is.na(e1_income_support)) %>% 
  group_by(country_name) %>% 
  summarise(media_fechamento_transporte = mean(c5_close_public_transport),
            media_suportederenda = mean(e1_income_support)) %>% 
  ggplot(mapping = aes(x = media_fechamento_transporte, y = media_suportederenda)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE)
  
#Análise da relação entre E4 e C8 
  
base %>% 
  select(country_name, e4_international_support, c8_international_travel_controls, type) %>% 
  filter(!is.na(e4_international_support), 
         !is.na(c8_international_travel_controls)) %>% 
  group_by(country_name) %>% 
  summarise(media_log_suporte = log(mean(e4_international_support)),
            media_controle = mean(c8_international_travel_controls), 
            tipe = type) %>% 
  filter(media_log_suporte > 0, !is.na(tipe)) %>% 
  ggplot(mapping = aes(x = media_controle, y = media_log_suporte, color = tipe)) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE) +
    theme_clean()

#Análise H2 e H5



```



Análise descritiva da base World Justice Project 2019



1) Agrupar de acordo com o grupo de renda e analisar, de forma geral, o score médio do Índice do WJP, visando obter alguma relação entre o nível de produto e a solidez institucional local
```{r}

wjp_income <- wjptidy %>% 
  group_by(`Income Group`) %>% 
  summarize(`WJP Rule of Law Index: Overall Score` = mean(`WJP Rule of Law Index: Overall Score`))

```



2)Agrupar de acordo com a região e analisar, de forma geral, o score médio do Índice do WJP, visando obter alguma relação entre a solidez institucional local e as regiões do mapa
```{r}

wjp_region <- wjptidy %>% 
  group_by(Region) %>% 
  summarize(`WJP Rule of Law Index: Overall Score` = mean(`WJP Rule of Law Index: Overall Score`))

```



3) Estudar a relação entre as médias do Fator 1 (Constraints on Government Powers) e do Fator 6 (Regulatory Enforcement)
```{r}

base %>% 
  select(country_name, type, iso_code, `Factor 1: Constraints on Government Powers`, `Factor 6: Regulatory Enforcement`) %>%
  filter(!is.na(type)) %>% 
  ggplot(mapping = aes(x = `Factor 6: Regulatory Enforcement`, y = `Factor 1: Constraints on Government Powers`)) +
  geom_point(mapping = aes(color = type)) +
  geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(wjptidy,`Factor 6: Regulatory Enforcement` > 0.8),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  theme_clean()

base %>% 
  select(country_name, type, iso_code, `Factor 1: Constraints on Government Powers`, `Factor 6: Regulatory Enforcement`) %>%
  filter(!is.na(type)) %>%
  ggplot(mapping = aes(x = `Factor 6: Regulatory Enforcement`, y = `Factor 1: Constraints on Government Powers`)) +
  geom_point(mapping = aes(color = type)) +
  geom_smooth(method = lm, se = FALSE) +
  theme_clean()

```



4)Estudar a relação entre a variável 7.3 (Civil Justice is free of discrimination) e o fator 2 (Absence of Corruption)
```{r}

wjptidy %>% 
  select(country_name, iso_code, `7.3 Civil justice is free of corruption`, `Factor 2: Absence of Corruption`) %>% 
  ggplot(mapping = aes(x = `7.3 Civil justice is free of corruption`, Factor, y = `Factor 2: Absence of Corruption`)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  geom_label_repel(data = subset(wjptidy,`7.3 Civil justice is free of corruption`>0.9),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') 

```



5) Estudar a relação entre as médias do Fator 5 (Order and Security) e do Fator 6 (Regulatory Enforcement)
```{r}

wjptidy %>% 
  select(country_name, iso_code, `Factor 5: Order and Security`, `Factor 6: Regulatory Enforcement`) %>% 
  ggplot(mapping = aes(x = `Factor 6: Regulatory Enforcement`, y = `Factor 5: Order and Security`)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(wjptidy,`Factor 6: Regulatory Enforcement`>0.82),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') 

```

Entre as bases

6) Relação entre o Overall Score do WJP e o Democracy Index, da The Economist
```{r}

x <- base %>% 
  filter(!is.na(`WJP Rule of Law Index: Overall Score`), 
         !is.na(`Overall Score`), date == "2020-01-10" )

base %>% 
  select(country_name, iso_code, `WJP Rule of Law Index: Overall Score`, `Overall Score`, date) %>% 
  filter(date == "2020-01-10") %>% 
  filter(!is.na(`WJP Rule of Law Index: Overall Score`), 
         !is.na(`Overall Score`)) %>% 
  ggplot(mapping = aes(x = `WJP Rule of Law Index: Overall Score`,
                       y = `Overall Score`)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(x, `WJP Rule of Law Index: Overall Score`>0.8),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') 

```


7)Relação entre a variável 3.3 (Civil Participation) do WJP e o Democracy Index, da The Economist

```{r}
gen_names_2 <- base %>% 
  filter(!is.na(`3.3 Civic participation`), 
         !is.na(`Overall Score`), date == "2020-01-10" )

base %>% 
  select(country_name, iso_code, `3.3 Civic participation`, `Overall Score`, date) %>% 
  filter(date == "2020-01-10") %>% 
  filter(!is.na(`3.3 Civic participation`), 
         !is.na(`Overall Score`)) %>% 
  ggplot(mapping = aes(x = `3.3 Civic participation`, y = `Overall Score`)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(gen_names_2, `3.3 Civic participation`>0.85),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') 
rm(gen_names_2)

```

9)Relação entre o fator 2 (Absence of Corruption) do WJP e o Democracy Index, da The Economist

```{r}

gen_names_3 <- base %>% 
  filter(!is.na(`Factor 2: Absence of Corruption`), 
         !is.na(`Overall Score`), date == "2020-01-10" )

base %>% 
  select(country_name, iso_code, `Factor 2: Absence of Corruption`, `Overall Score`, date) %>% 
  filter(date == "2020-01-10") %>% 
  filter(!is.na(`Factor 2: Absence of Corruption`), 
         !is.na(`Overall Score`)) %>% 
  ggplot(mapping = aes(x = `Factor 2: Absence of Corruption`, y = `Overall Score`)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(gen_names_3, `Factor 2: Absence of Corruption`>0.85),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') 
rm(gen_names_3)

```

10)Relação entre a média do Fator 6 e as taxas populacionais de falecimento e de casos totais por COVID-19

```{r}

gen_names_4 <- base %>% 
  filter(!is.na(`Factor 6: Regulatory Enforcement`), !is.na(total_cases_per_million), 
         !is.na(total_deaths_per_million), date == "2020-09-10" )

#Usar datas comparáveis (days_after_1pm)
base %>% 
  select(country_name, iso_code, total_cases_per_million, `Factor 6: Regulatory Enforcement`, days_after_1pm) %>% 
  filter(days_after_1pm == 100) %>% 
  filter(!is.na(`Factor 6: Regulatory Enforcement`), 
         !is.na(total_cases_per_million)) %>% 
  ggplot(mapping = aes(y = log(total_cases_per_million), x = `Factor 6: Regulatory Enforcement`)) +
  geom_point() +
  #geom_smooth(method = lm, se = FALSE) +
  geom_label_repel(data = subset(gen_names_4, total_cases_per_million>15000),
                   aes(label = country_name),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50') +
  labs(title = "Regulatory enforcement and COVID-19 cases/million plot", 
       subtitle = ("Mid September"))
       
rm(gen_names_4)

```

11)Relação entre o Fator 4 (Fundamental Rights) e a variável C6 (Stay at home requirements) do Oxford Response Tracker

```{r}

base %>% 
  select(country_name, iso_code, `Factor 4: Fundamental Rights`, c6_stay_at_home_requirements, days_after_1pm) %>% 
  filter(!is.na(`Factor 4: Fundamental Rights`), 
         !is.na(c6_stay_at_home_requirements),!is.na(days_after_1pm), days_after_1pm == 2) %>% 
  ggplot(mapping = aes(x = c6_stay_at_home_requirements, y = `Factor 4: Fundamental Rights`)) +
  geom_point() 

```

11B)Relação animada conforme dias após o marco 1 morte por milhão

```{r}
p11 <- base %>% 
  select(country_name, iso_code, `Factor 4: Fundamental Rights`, c6_stay_at_home_requirements, days_after_1pm) %>% 
  filter(!is.na(`Factor 4: Fundamental Rights`), 
         !is.na(c6_stay_at_home_requirements),!is.na(days_after_1pm)) %>% 
  ggplot(mapping = aes(x = c6_stay_at_home_requirements, y = `Factor 4: Fundamental Rights`)) +
  geom_point(alpha = 0.5) +
  theme_clean()

anim11 <- p11 + transition_time(days_after_1pm) +
  labs(title = "Days after 1 death per million: {frame_time}")

animate(anim11, renderer = av_renderer("gifregulatory.gif"))
```


PEGAR UM GRÁFICO COM GINI NO HORIZONTAL, NO VERTICAL TOTAL DE CASOS POR MILHÃO; COM TUDO TRAVADO EM ALGUM DIA DEPOIS DE CASOS POR MILHÃO; USAR FACET_WRAP POR TAMANHO DA POPULAÇÃO (DIVIDIR EM 3 GRUPOS)
FAZER COM RENDA (GRUPOS DE RENDA) TAMBÉM
FAZER POR REGIÃO TAMBÉM


B) Testes de Regressão
```{r}
b <- base %>% 
  filter(days_after_1pm > 0) 

reg <- lm(total_cases_per_million ~ `Overall Score` +`WJP Rule of Law Index: Overall Score` + gini_index_world_bank_estimate + population + gdp_per_capita + aged_65_older + median_age + population_density + Region + `Income Group`, data = b)

summary(reg)


reg1 <- lm_robust(total_cases_per_million ~ ., data = subset(b, select=c(-country_name, -iso_code, -date, -iso2, -confirmed_cases, -total_cases, -new_cases, -total_deaths, -new_deaths, -new_cases_per_million, -confirmed_deaths, -total_deaths_per_million, -`Short-term tests per case`, -`Short-term positive rate`,-`Cumulative total`, -`Cumulative total per thousand`, -`7-day smoothed daily change`, -`7-day smoothed daily change per thousand`, -`Daily change in cumulative total per thousand`, -new_deaths_smoothed_per_million, -new_deaths_per_million, -new_cases_smoothed_per_million, -new_deaths_smoothed, -new_cases_smoothed, -`Daily change in cumulative total`)))
           
tidy(reg1) %>% 
  filter(p.value < 0.05)

summary(reg1)

# Pesquisar sobre PCA (Principal Component Analysis) -> BEM LEGAL

```






